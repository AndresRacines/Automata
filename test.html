<!DOCTYPE HTML5>
<html>
<head>
    <title>Automata test.</title>
</head>
<body>
<script src="automata.js"></script>
<script>


var context= module.exports;

var Logic= function() {

    this.count=0;

    this.enter_a= function() {
        console.log("enter_a");
    };

    this.exit_a= function() {
        console.log("exit_a");
    };

    this.enter_b= function() {
        console.log("enter_b");
    };

    this.exit_b= function() {
        console.log("exit_b");
    };

    this.enter_c= function() {
        console.log("enter_c");
    };

    this.exit_c= function() {
        console.log("exit_c");
    };

    this.action_tr_ab= function() {
        console.log("action_tr_ab");
    };

    this.pre_guard_tr_ab= function() {
        this.count++;
        console.log("count= "+this.count);
        if ( this.count<3 ) {
            throw "PreGuard_tr_AB";
        } else {
            console.log("okokokok");
        }
    };

    this.post_guard_tr_ab= function() {
        this.count++;
        console.log("count= "+this.count);
        if ( this.count<5 ) {
            throw "PostGuard_tr_AB";
        }
    };

    return this;
};

context.registerFSM( {
    name    : "STest",

    state  : [
        {
            name    : "1",
            initial : true,

            onTimer : {
                timeout : 2000,
                event   : {
                    msgId : "12"
                }
            },
            onEnter : function() {
                console.log("Enter substate");
            }

        },
        {
            name    : "2",
            onEnter : function( session, state, transition, msg) {
                this.__count=7;
                session.dispatch( {
                    msgId : "23"
                });
            }
        },
        {
            name    : "3"
        }
    ],

    transition : [
        {
            event       : "12",
            from        : "1",
            to          : "2"
        },
        {
            event       : "23",
            from        : "2",
            to          : "3"
        }
    ]
} );

context.registerFSM( {

    name    : "Test",
    logic   : Logic,

    state  : [
        {
            name    : "a",
            initial : true,
            onEnter : "enter_a",
            onExit  : "exit_a"
        },
        {
            name    : "b",
            onEnter : "enter_b",
            onExit  : "exit_b"
        },
        {
            subState: "STest"
        },
        {
            name    : "c",
            onEnter : "enter_c",
            onExit  : "exit_c"
        }
    ],

    transition : [
        {
            event       : "ab",
            from        : "a",
            to          : "b",
            onTransition: "action_tr_ab",
            onPreGuard  : "pre_guard_tr_ab",
            onPostGuard : "post_guard_tr_ab"
        },
        {
            event   : "bc",
            from    : "b",
            to      : "STest"
        },
        {
            event   : "cd",
            from    : "STest",
            to      : "c"
        }
    ],

    onEnter : function() {

    },

    onExit : function() {

    }
});

var session= context.createSession("Test");
session.addListener( {
    contextCreated      : function( obj ) {
        console.log("SessionListener contextCreated");
    },
    contextDestroyed    : function( obj ) {
        console.log("SessionListener contextDestroyed");
    },
    finalStateReached   : function( obj ) {
        console.log("SessionListener finalStateReached");
    },
    stateChanged        : function( obj ) {
        console.log("SessionListener stateChanged");
    },
    customEvent         : function( obj ) {
        console.log("SessionListener customEvent");
    }
} );

session.printStackTrace();
console.log("..");

session.processMessage( {
    msgId:  "ab"
} );
console.log("..");

session.processMessage( {
    msgId:  "ab"
} );
console.log("..");

session.processMessage( {
    msgId:  "ab"
} );
console.log("..");

session.processMessage( {
    msgId:  "ab"
} );
console.log("..");

session.processMessage( {
    msgId:  "bc"
} );
console.log("..");


session.printStackTrace();
console.log("..");















</script>
</body>
</html>